version: 2.1

jobs:
  quality:
    docker:
      - image: cimg/python:3.13
    resource_class: medium
    working_directory: ~/project
    steps:
      - run:
          name: Configure SSH and checkout
          command: |
            mkdir -p ~/.ssh
            echo "$CHECKOUT_SSH_KEY_B64" | base64 -d > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keygen -p -N "" -P "$CHECKOUT_SSH_KEY_PASS" -f ~/.ssh/id_ed25519
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            git clone --branch "$CIRCLE_BRANCH" --depth 1 \
              "git@github.com:L3DigitalNet/$CIRCLE_PROJECT_REPONAME.git" .
      - restore_cache:
          keys:
            - pip-deps-v1-{{ checksum "pyproject.toml" }}
            - pip-deps-v1-
      - run:
          name: Install dependencies
          command: |
            pip install -q homeassistant aiohttp voluptuous
            pip install -q pytest pytest-asyncio pytest-homeassistant-custom-component pytest-cov
            pip install -q ruff mypy
      - save_cache:
          key: pip-deps-v1-{{ checksum "pyproject.toml" }}
          paths:
            - ~/.cache/pip
      - run:
          name: Lint
          command: ruff check custom_components/ tests/
      - run:
          name: Format check
          command: ruff format --check custom_components/ tests/
      - run:
          name: Type check
          command: mypy custom_components/
      - run:
          name: Tests
          command: |
            mkdir -p test-results
            pytest tests/ \
              --cov=custom_components \
              --cov-report=xml \
              --junitxml=test-results/junit.xml \
              -v
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage.xml
          destination: coverage

workflows:
  ci:
    jobs:
      - quality:
          filters:
            branches:
              only:
                - main
                - testing
                - /ci\/.*/
                - /feature\/.*/
